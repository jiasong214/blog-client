{"ast":null,"code":"\"use strict\";\n\nvar __createBinding = this && this.__createBinding || (Object.create ? function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  Object.defineProperty(o, k2, {\n    enumerable: true,\n    get: function () {\n      return m[k];\n    }\n  });\n} : function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  o[k2] = m[k];\n});\n\nvar __setModuleDefault = this && this.__setModuleDefault || (Object.create ? function (o, v) {\n  Object.defineProperty(o, \"default\", {\n    enumerable: true,\n    value: v\n  });\n} : function (o, v) {\n  o[\"default\"] = v;\n});\n\nvar __importStar = this && this.__importStar || function (mod) {\n  if (mod && mod.__esModule) return mod;\n  var result = {};\n  if (mod != null) for (var k in mod) if (k !== \"default\" && Object.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n\n  __setModuleDefault(result, mod);\n\n  return result;\n};\n\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nconst prosemirror_inputrules_1 = require(\"prosemirror-inputrules\");\n\nconst react_dom_1 = __importDefault(require(\"react-dom\"));\n\nconst React = __importStar(require(\"react\"));\n\nconst prosemirror_state_1 = require(\"prosemirror-state\");\n\nconst prosemirror_tables_1 = require(\"prosemirror-tables\");\n\nconst prosemirror_utils_1 = require(\"prosemirror-utils\");\n\nconst outline_icons_1 = require(\"outline-icons\");\n\nconst prosemirror_view_1 = require(\"prosemirror-view\");\n\nconst Extension_1 = __importDefault(require(\"../lib/Extension\"));\n\nconst MAX_MATCH = 500;\nconst OPEN_REGEX = /^\\/(\\w+)?$/;\nconst CLOSE_REGEX = /(^(?!\\/(\\w+)?)(.*)$|^\\/((\\w+)\\s.*|\\s)$)/;\n\nfunction run(view, from, to, regex, handler) {\n  if (view.composing) {\n    return false;\n  }\n\n  const state = view.state;\n  const $from = state.doc.resolve(from);\n\n  if ($from.parent.type.spec.code) {\n    return false;\n  }\n\n  const textBefore = $from.parent.textBetween(Math.max(0, $from.parentOffset - MAX_MATCH), $from.parentOffset, null, \"\\ufffc\");\n  const match = regex.exec(textBefore);\n  const tr = handler(state, match, match ? from - match[0].length : from, to);\n  if (!tr) return false;\n  return true;\n}\n\nclass BlockMenuTrigger extends Extension_1.default {\n  get name() {\n    return \"blockmenu\";\n  }\n\n  get plugins() {\n    const button = document.createElement(\"button\");\n    button.className = \"block-menu-trigger\";\n    button.type = \"button\";\n    react_dom_1.default.render(React.createElement(outline_icons_1.PlusIcon, {\n      fill: \"currentColor\"\n    }), button);\n    return [new prosemirror_state_1.Plugin({\n      props: {\n        handleClick: () => {\n          this.options.onClose();\n          return false;\n        },\n        handleKeyDown: (view, event) => {\n          if (event.key === \"Backspace\") {\n            setTimeout(() => {\n              const {\n                pos\n              } = view.state.selection.$from;\n              return run(view, pos, pos, OPEN_REGEX, (state, match) => {\n                if (match) {\n                  this.options.onOpen(match[1]);\n                } else {\n                  this.options.onClose();\n                }\n\n                return null;\n              });\n            });\n          }\n\n          if (event.key === \"Enter\" || event.key === \"ArrowUp\" || event.key === \"ArrowDown\" || event.key === \"Tab\") {\n            const {\n              pos\n            } = view.state.selection.$from;\n            return run(view, pos, pos, OPEN_REGEX, (state, match) => {\n              return match ? true : null;\n            });\n          }\n\n          return false;\n        },\n        decorations: state => {\n          const parent = prosemirror_utils_1.findParentNode(node => node.type.name === \"paragraph\")(state.selection);\n\n          if (!parent) {\n            return;\n          }\n\n          const decorations = [];\n          const isEmpty = parent && parent.node.content.size === 0;\n          const isSlash = parent && parent.node.textContent === \"/\";\n          const isTopLevel = state.selection.$from.depth === 1;\n\n          if (isTopLevel) {\n            if (isEmpty) {\n              decorations.push(prosemirror_view_1.Decoration.widget(parent.pos, () => {\n                button.addEventListener(\"click\", () => {\n                  this.options.onOpen(\"\");\n                });\n                return button;\n              }));\n              decorations.push(prosemirror_view_1.Decoration.node(parent.pos, parent.pos + parent.node.nodeSize, {\n                class: \"placeholder\",\n                \"data-empty-text\": this.options.dictionary.newLineEmpty\n              }));\n            }\n\n            if (isSlash) {\n              decorations.push(prosemirror_view_1.Decoration.node(parent.pos, parent.pos + parent.node.nodeSize, {\n                class: \"placeholder\",\n                \"data-empty-text\": `  ${this.options.dictionary.newLineWithSlash}`\n              }));\n            }\n\n            return prosemirror_view_1.DecorationSet.create(state.doc, decorations);\n          }\n\n          return;\n        }\n      }\n    })];\n  }\n\n  inputRules() {\n    return [new prosemirror_inputrules_1.InputRule(OPEN_REGEX, (state, match) => {\n      if (match && state.selection.$from.parent.type.name === \"paragraph\" && !prosemirror_tables_1.isInTable(state)) {\n        this.options.onOpen(match[1]);\n      }\n\n      return null;\n    }), new prosemirror_inputrules_1.InputRule(CLOSE_REGEX, (state, match) => {\n      if (match) {\n        this.options.onClose();\n      }\n\n      return null;\n    })];\n  }\n\n}\n\nexports.default = BlockMenuTrigger;","map":{"version":3,"sources":["../../src/plugins/BlockMenuTrigger.tsx"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["\"use strict\";\nvar __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });\n}) : (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    o[k2] = m[k];\n}));\nvar __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {\n    Object.defineProperty(o, \"default\", { enumerable: true, value: v });\n}) : function(o, v) {\n    o[\"default\"] = v;\n});\nvar __importStar = (this && this.__importStar) || function (mod) {\n    if (mod && mod.__esModule) return mod;\n    var result = {};\n    if (mod != null) for (var k in mod) if (k !== \"default\" && Object.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n    __setModuleDefault(result, mod);\n    return result;\n};\nvar __importDefault = (this && this.__importDefault) || function (mod) {\n    return (mod && mod.__esModule) ? mod : { \"default\": mod };\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nconst prosemirror_inputrules_1 = require(\"prosemirror-inputrules\");\nconst react_dom_1 = __importDefault(require(\"react-dom\"));\nconst React = __importStar(require(\"react\"));\nconst prosemirror_state_1 = require(\"prosemirror-state\");\nconst prosemirror_tables_1 = require(\"prosemirror-tables\");\nconst prosemirror_utils_1 = require(\"prosemirror-utils\");\nconst outline_icons_1 = require(\"outline-icons\");\nconst prosemirror_view_1 = require(\"prosemirror-view\");\nconst Extension_1 = __importDefault(require(\"../lib/Extension\"));\nconst MAX_MATCH = 500;\nconst OPEN_REGEX = /^\\/(\\w+)?$/;\nconst CLOSE_REGEX = /(^(?!\\/(\\w+)?)(.*)$|^\\/((\\w+)\\s.*|\\s)$)/;\nfunction run(view, from, to, regex, handler) {\n    if (view.composing) {\n        return false;\n    }\n    const state = view.state;\n    const $from = state.doc.resolve(from);\n    if ($from.parent.type.spec.code) {\n        return false;\n    }\n    const textBefore = $from.parent.textBetween(Math.max(0, $from.parentOffset - MAX_MATCH), $from.parentOffset, null, \"\\ufffc\");\n    const match = regex.exec(textBefore);\n    const tr = handler(state, match, match ? from - match[0].length : from, to);\n    if (!tr)\n        return false;\n    return true;\n}\nclass BlockMenuTrigger extends Extension_1.default {\n    get name() {\n        return \"blockmenu\";\n    }\n    get plugins() {\n        const button = document.createElement(\"button\");\n        button.className = \"block-menu-trigger\";\n        button.type = \"button\";\n        react_dom_1.default.render(React.createElement(outline_icons_1.PlusIcon, { fill: \"currentColor\" }), button);\n        return [\n            new prosemirror_state_1.Plugin({\n                props: {\n                    handleClick: () => {\n                        this.options.onClose();\n                        return false;\n                    },\n                    handleKeyDown: (view, event) => {\n                        if (event.key === \"Backspace\") {\n                            setTimeout(() => {\n                                const { pos } = view.state.selection.$from;\n                                return run(view, pos, pos, OPEN_REGEX, (state, match) => {\n                                    if (match) {\n                                        this.options.onOpen(match[1]);\n                                    }\n                                    else {\n                                        this.options.onClose();\n                                    }\n                                    return null;\n                                });\n                            });\n                        }\n                        if (event.key === \"Enter\" ||\n                            event.key === \"ArrowUp\" ||\n                            event.key === \"ArrowDown\" ||\n                            event.key === \"Tab\") {\n                            const { pos } = view.state.selection.$from;\n                            return run(view, pos, pos, OPEN_REGEX, (state, match) => {\n                                return match ? true : null;\n                            });\n                        }\n                        return false;\n                    },\n                    decorations: state => {\n                        const parent = prosemirror_utils_1.findParentNode(node => node.type.name === \"paragraph\")(state.selection);\n                        if (!parent) {\n                            return;\n                        }\n                        const decorations = [];\n                        const isEmpty = parent && parent.node.content.size === 0;\n                        const isSlash = parent && parent.node.textContent === \"/\";\n                        const isTopLevel = state.selection.$from.depth === 1;\n                        if (isTopLevel) {\n                            if (isEmpty) {\n                                decorations.push(prosemirror_view_1.Decoration.widget(parent.pos, () => {\n                                    button.addEventListener(\"click\", () => {\n                                        this.options.onOpen(\"\");\n                                    });\n                                    return button;\n                                }));\n                                decorations.push(prosemirror_view_1.Decoration.node(parent.pos, parent.pos + parent.node.nodeSize, {\n                                    class: \"placeholder\",\n                                    \"data-empty-text\": this.options.dictionary.newLineEmpty,\n                                }));\n                            }\n                            if (isSlash) {\n                                decorations.push(prosemirror_view_1.Decoration.node(parent.pos, parent.pos + parent.node.nodeSize, {\n                                    class: \"placeholder\",\n                                    \"data-empty-text\": `  ${this.options.dictionary.newLineWithSlash}`,\n                                }));\n                            }\n                            return prosemirror_view_1.DecorationSet.create(state.doc, decorations);\n                        }\n                        return;\n                    },\n                },\n            }),\n        ];\n    }\n    inputRules() {\n        return [\n            new prosemirror_inputrules_1.InputRule(OPEN_REGEX, (state, match) => {\n                if (match &&\n                    state.selection.$from.parent.type.name === \"paragraph\" &&\n                    !prosemirror_tables_1.isInTable(state)) {\n                    this.options.onOpen(match[1]);\n                }\n                return null;\n            }),\n            new prosemirror_inputrules_1.InputRule(CLOSE_REGEX, (state, match) => {\n                if (match) {\n                    this.options.onClose();\n                }\n                return null;\n            }),\n        ];\n    }\n}\nexports.default = BlockMenuTrigger;\n//# sourceMappingURL=BlockMenuTrigger.js.map"]},"metadata":{},"sourceType":"script"}