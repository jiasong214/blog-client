{"ast":null,"code":"\"use strict\";\n\nvar __createBinding = this && this.__createBinding || (Object.create ? function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  Object.defineProperty(o, k2, {\n    enumerable: true,\n    get: function () {\n      return m[k];\n    }\n  });\n} : function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  o[k2] = m[k];\n});\n\nvar __setModuleDefault = this && this.__setModuleDefault || (Object.create ? function (o, v) {\n  Object.defineProperty(o, \"default\", {\n    enumerable: true,\n    value: v\n  });\n} : function (o, v) {\n  o[\"default\"] = v;\n});\n\nvar __importStar = this && this.__importStar || function (mod) {\n  if (mod && mod.__esModule) return mod;\n  var result = {};\n  if (mod != null) for (var k in mod) if (k !== \"default\" && Object.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n\n  __setModuleDefault(result, mod);\n\n  return result;\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nconst uploadPlaceholder_1 = __importStar(require(\"../lib/uploadPlaceholder\"));\n\nconst types_1 = require(\"../types\");\n\nconst insertFiles = function (view, event, pos, files, options) {\n  const images = files.filter(file => /image/i.test(file.type));\n  if (images.length === 0) return;\n  const {\n    dictionary,\n    uploadImage,\n    onImageUploadStart,\n    onImageUploadStop,\n    onShowToast\n  } = options;\n\n  if (!uploadImage) {\n    console.warn(\"uploadImage callback must be defined to handle image uploads.\");\n    return;\n  }\n\n  event.preventDefault();\n  if (onImageUploadStart) onImageUploadStart();\n  const {\n    schema\n  } = view.state;\n  let complete = 0;\n\n  for (const file of images) {\n    const id = {};\n    const {\n      tr\n    } = view.state;\n    tr.setMeta(uploadPlaceholder_1.default, {\n      add: {\n        id,\n        file,\n        pos\n      }\n    });\n    view.dispatch(tr);\n    uploadImage(file).then(src => {\n      const pos = uploadPlaceholder_1.findPlaceholder(view.state, id);\n      if (pos === null) return;\n      const newImg = new Image();\n\n      newImg.onload = () => {\n        const transaction = view.state.tr.replaceWith(pos, pos, schema.nodes.image.create({\n          src\n        })).setMeta(uploadPlaceholder_1.default, {\n          remove: {\n            id\n          }\n        });\n        view.dispatch(transaction);\n      };\n\n      newImg.onerror = error => {\n        throw error;\n      };\n\n      newImg.src = src;\n    }).catch(error => {\n      console.error(error);\n      const transaction = view.state.tr.setMeta(uploadPlaceholder_1.default, {\n        remove: {\n          id\n        }\n      });\n      view.dispatch(transaction);\n\n      if (onShowToast) {\n        onShowToast(dictionary.imageUploadError, types_1.ToastType.Error);\n      }\n    }).finally(() => {\n      complete++;\n\n      if (complete === images.length) {\n        if (onImageUploadStop) onImageUploadStop();\n      }\n    });\n  }\n};\n\nexports.default = insertFiles;","map":{"version":3,"sources":["../../src/commands/insertFiles.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["\"use strict\";\nvar __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });\n}) : (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    o[k2] = m[k];\n}));\nvar __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {\n    Object.defineProperty(o, \"default\", { enumerable: true, value: v });\n}) : function(o, v) {\n    o[\"default\"] = v;\n});\nvar __importStar = (this && this.__importStar) || function (mod) {\n    if (mod && mod.__esModule) return mod;\n    var result = {};\n    if (mod != null) for (var k in mod) if (k !== \"default\" && Object.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n    __setModuleDefault(result, mod);\n    return result;\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nconst uploadPlaceholder_1 = __importStar(require(\"../lib/uploadPlaceholder\"));\nconst types_1 = require(\"../types\");\nconst insertFiles = function (view, event, pos, files, options) {\n    const images = files.filter(file => /image/i.test(file.type));\n    if (images.length === 0)\n        return;\n    const { dictionary, uploadImage, onImageUploadStart, onImageUploadStop, onShowToast, } = options;\n    if (!uploadImage) {\n        console.warn(\"uploadImage callback must be defined to handle image uploads.\");\n        return;\n    }\n    event.preventDefault();\n    if (onImageUploadStart)\n        onImageUploadStart();\n    const { schema } = view.state;\n    let complete = 0;\n    for (const file of images) {\n        const id = {};\n        const { tr } = view.state;\n        tr.setMeta(uploadPlaceholder_1.default, {\n            add: { id, file, pos },\n        });\n        view.dispatch(tr);\n        uploadImage(file)\n            .then(src => {\n            const pos = uploadPlaceholder_1.findPlaceholder(view.state, id);\n            if (pos === null)\n                return;\n            const newImg = new Image();\n            newImg.onload = () => {\n                const transaction = view.state.tr\n                    .replaceWith(pos, pos, schema.nodes.image.create({ src }))\n                    .setMeta(uploadPlaceholder_1.default, { remove: { id } });\n                view.dispatch(transaction);\n            };\n            newImg.onerror = error => {\n                throw error;\n            };\n            newImg.src = src;\n        })\n            .catch(error => {\n            console.error(error);\n            const transaction = view.state.tr.setMeta(uploadPlaceholder_1.default, {\n                remove: { id },\n            });\n            view.dispatch(transaction);\n            if (onShowToast) {\n                onShowToast(dictionary.imageUploadError, types_1.ToastType.Error);\n            }\n        })\n            .finally(() => {\n            complete++;\n            if (complete === images.length) {\n                if (onImageUploadStop)\n                    onImageUploadStop();\n            }\n        });\n    }\n};\nexports.default = insertFiles;\n//# sourceMappingURL=insertFiles.js.map"]},"metadata":{},"sourceType":"script"}