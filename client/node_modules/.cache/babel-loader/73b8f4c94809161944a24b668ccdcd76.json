{"ast":null,"code":"\"use strict\";\n\nvar __createBinding = this && this.__createBinding || (Object.create ? function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  Object.defineProperty(o, k2, {\n    enumerable: true,\n    get: function () {\n      return m[k];\n    }\n  });\n} : function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  o[k2] = m[k];\n});\n\nvar __setModuleDefault = this && this.__setModuleDefault || (Object.create ? function (o, v) {\n  Object.defineProperty(o, \"default\", {\n    enumerable: true,\n    value: v\n  });\n} : function (o, v) {\n  o[\"default\"] = v;\n});\n\nvar __importStar = this && this.__importStar || function (mod) {\n  if (mod && mod.__esModule) return mod;\n  var result = {};\n  if (mod != null) for (var k in mod) if (k !== \"default\" && Object.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n\n  __setModuleDefault(result, mod);\n\n  return result;\n};\n\nvar __rest = this && this.__rest || function (s, e) {\n  var t = {};\n\n  for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0) t[p] = s[p];\n\n  if (s != null && typeof Object.getOwnPropertySymbols === \"function\") for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {\n    if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i])) t[p[i]] = s[p[i]];\n  }\n  return t;\n};\n\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.Wrapper = void 0;\n\nconst React = __importStar(require(\"react\"));\n\nconst capitalize_1 = __importDefault(require(\"lodash/capitalize\"));\n\nconst react_portal_1 = require(\"react-portal\");\n\nconst prosemirror_utils_1 = require(\"prosemirror-utils\");\n\nconst styled_components_1 = __importDefault(require(\"styled-components\"));\n\nconst types_1 = require(\"../types\");\n\nconst BlockMenuItem_1 = __importDefault(require(\"./BlockMenuItem\"));\n\nconst Input_1 = __importDefault(require(\"./Input\"));\n\nconst VisuallyHidden_1 = __importDefault(require(\"./VisuallyHidden\"));\n\nconst getDataTransferFiles_1 = __importDefault(require(\"../lib/getDataTransferFiles\"));\n\nconst insertFiles_1 = __importDefault(require(\"../commands/insertFiles\"));\n\nconst block_1 = __importDefault(require(\"../menus/block\"));\n\nconst SSR = typeof window === \"undefined\";\nconst defaultPosition = {\n  left: -1000,\n  top: 0,\n  bottom: undefined,\n  isAbove: false\n};\n\nclass BlockMenu extends React.Component {\n  constructor() {\n    super(...arguments);\n    this.menuRef = React.createRef();\n    this.inputRef = React.createRef();\n    this.state = {\n      left: -1000,\n      top: 0,\n      bottom: undefined,\n      isAbove: false,\n      selectedIndex: 0,\n      insertItem: undefined\n    };\n\n    this.handleKeyDown = event => {\n      if (!this.props.isActive) return;\n\n      if (event.key === \"Enter\") {\n        event.preventDefault();\n        event.stopPropagation();\n        const item = this.filtered[this.state.selectedIndex];\n\n        if (item) {\n          this.insertItem(item);\n        } else {\n          this.props.onClose();\n        }\n      }\n\n      if (event.key === \"ArrowUp\" || event.ctrlKey && event.key === \"p\") {\n        event.preventDefault();\n        event.stopPropagation();\n\n        if (this.filtered.length) {\n          const prevIndex = this.state.selectedIndex - 1;\n          const prev = this.filtered[prevIndex];\n          this.setState({\n            selectedIndex: Math.max(0, prev && prev.name === \"separator\" ? prevIndex - 1 : prevIndex)\n          });\n        } else {\n          this.close();\n        }\n      }\n\n      if (event.key === \"ArrowDown\" || event.key === \"Tab\" || event.ctrlKey && event.key === \"n\") {\n        event.preventDefault();\n        event.stopPropagation();\n\n        if (this.filtered.length) {\n          const total = this.filtered.length - 1;\n          const nextIndex = this.state.selectedIndex + 1;\n          const next = this.filtered[nextIndex];\n          this.setState({\n            selectedIndex: Math.min(next && next.name === \"separator\" ? nextIndex + 1 : nextIndex, total)\n          });\n        } else {\n          this.close();\n        }\n      }\n\n      if (event.key === \"Escape\") {\n        this.close();\n      }\n    };\n\n    this.insertItem = item => {\n      switch (item.name) {\n        case \"image\":\n          return this.triggerImagePick();\n\n        case \"embed\":\n          return this.triggerLinkInput(item);\n\n        case \"link\":\n          {\n            this.clearSearch();\n            this.props.onClose();\n            this.props.onLinkToolbarOpen();\n            return;\n          }\n\n        default:\n          this.insertBlock(item);\n      }\n    };\n\n    this.close = () => {\n      this.props.onClose();\n      this.props.view.focus();\n    };\n\n    this.handleLinkInputKeydown = event => {\n      if (!this.props.isActive) return;\n      if (!this.state.insertItem) return;\n\n      if (event.key === \"Enter\") {\n        event.preventDefault();\n        event.stopPropagation();\n        const href = event.currentTarget.value;\n        const matches = this.state.insertItem.matcher(href);\n\n        if (!matches && this.props.onShowToast) {\n          this.props.onShowToast(this.props.dictionary.embedInvalidLink, types_1.ToastType.Error);\n          return;\n        }\n\n        this.insertBlock({\n          name: \"embed\",\n          attrs: {\n            href,\n            component: this.state.insertItem.component,\n            matches\n          }\n        });\n      }\n\n      if (event.key === \"Escape\") {\n        this.props.onClose();\n        this.props.view.focus();\n      }\n    };\n\n    this.handleLinkInputPaste = event => {\n      if (!this.props.isActive) return;\n      if (!this.state.insertItem) return;\n      const href = event.clipboardData.getData(\"text/plain\");\n      const matches = this.state.insertItem.matcher(href);\n\n      if (matches) {\n        event.preventDefault();\n        event.stopPropagation();\n        this.insertBlock({\n          name: \"embed\",\n          attrs: {\n            href,\n            component: this.state.insertItem.component,\n            matches\n          }\n        });\n      }\n    };\n\n    this.triggerImagePick = () => {\n      if (this.inputRef.current) {\n        this.inputRef.current.click();\n      }\n    };\n\n    this.triggerLinkInput = item => {\n      this.setState({\n        insertItem: item\n      });\n    };\n\n    this.handleImagePicked = event => {\n      const files = getDataTransferFiles_1.default(event);\n      const {\n        view,\n        uploadImage,\n        onImageUploadStart,\n        onImageUploadStop,\n        onShowToast\n      } = this.props;\n      const {\n        state\n      } = view;\n      const parent = prosemirror_utils_1.findParentNode(node => !!node)(state.selection);\n      this.clearSearch();\n\n      if (parent) {\n        insertFiles_1.default(view, event, parent.pos, files, {\n          uploadImage,\n          onImageUploadStart,\n          onImageUploadStop,\n          onShowToast,\n          dictionary: this.props.dictionary\n        });\n      }\n\n      if (this.inputRef.current) {\n        this.inputRef.current.value = \"\";\n      }\n\n      this.props.onClose();\n    };\n  }\n\n  componentDidMount() {\n    if (!SSR) {\n      window.addEventListener(\"keydown\", this.handleKeyDown);\n    }\n  }\n\n  shouldComponentUpdate(nextProps, nextState) {\n    return nextProps.search !== this.props.search || nextProps.isActive !== this.props.isActive || nextState !== this.state;\n  }\n\n  componentDidUpdate(prevProps) {\n    if (!prevProps.isActive && this.props.isActive) {\n      const position = this.calculatePosition(this.props);\n      this.setState(Object.assign({\n        insertItem: undefined,\n        selectedIndex: 0\n      }, position));\n    } else if (prevProps.search !== this.props.search) {\n      this.setState({\n        selectedIndex: 0\n      });\n    }\n  }\n\n  componentWillUnmount() {\n    if (!SSR) {\n      window.removeEventListener(\"keydown\", this.handleKeyDown);\n    }\n  }\n\n  clearSearch() {\n    const {\n      state,\n      dispatch\n    } = this.props.view;\n    const parent = prosemirror_utils_1.findParentNode(node => !!node)(state.selection);\n\n    if (parent) {\n      dispatch(state.tr.insertText(\"\", parent.pos, state.selection.to));\n    }\n  }\n\n  insertBlock(item) {\n    this.clearSearch();\n    const command = this.props.commands[item.name];\n\n    if (command) {\n      command(item.attrs);\n    } else {\n      this.props.commands[`create${capitalize_1.default(item.name)}`](item.attrs);\n    }\n\n    this.props.onClose();\n  }\n\n  get caretPosition() {\n    const selection = window.document.getSelection();\n\n    if (!selection || !selection.anchorNode || !selection.focusNode) {\n      return {\n        top: 0,\n        left: 0\n      };\n    }\n\n    const range = window.document.createRange();\n    range.setStart(selection.anchorNode, selection.anchorOffset);\n    range.setEnd(selection.focusNode, selection.focusOffset);\n    const rects = range.getClientRects();\n\n    if (rects.length === 0) {\n      if (range.startContainer && range.collapsed) {\n        range.selectNodeContents(range.startContainer);\n      }\n    }\n\n    const rect = range.getBoundingClientRect();\n    return {\n      top: rect.top,\n      left: rect.left\n    };\n  }\n\n  calculatePosition(props) {\n    const {\n      view\n    } = props;\n    const {\n      selection\n    } = view.state;\n    let startPos;\n\n    try {\n      startPos = view.coordsAtPos(selection.from);\n    } catch (err) {\n      console.warn(err);\n      return defaultPosition;\n    }\n\n    const ref = this.menuRef.current;\n    const offsetHeight = ref ? ref.offsetHeight : 0;\n    const paragraph = view.domAtPos(selection.from);\n\n    if (!props.isActive || !paragraph.node || !paragraph.node.getBoundingClientRect || SSR) {\n      return defaultPosition;\n    }\n\n    const {\n      left\n    } = this.caretPosition;\n    const {\n      top,\n      bottom,\n      right\n    } = paragraph.node.getBoundingClientRect();\n    const margin = 24;\n    let leftPos = left + window.scrollX;\n\n    if (props.rtl && ref) {\n      leftPos = right - ref.scrollWidth;\n    }\n\n    if (startPos.top - offsetHeight > margin) {\n      return {\n        left: leftPos,\n        top: undefined,\n        bottom: window.innerHeight - top - window.scrollY,\n        isAbove: false\n      };\n    } else {\n      return {\n        left: leftPos,\n        top: bottom + window.scrollY,\n        bottom: undefined,\n        isAbove: true\n      };\n    }\n  }\n\n  get filtered() {\n    const {\n      dictionary,\n      embeds,\n      search = \"\",\n      uploadImage,\n      commands\n    } = this.props;\n    let items = block_1.default(dictionary);\n    const embedItems = [];\n\n    for (const embed of embeds) {\n      if (embed.title && embed.icon) {\n        embedItems.push(Object.assign(Object.assign({}, embed), {\n          name: \"embed\"\n        }));\n      }\n    }\n\n    if (embedItems.length) {\n      items.push({\n        name: \"separator\"\n      });\n      items = items.concat(embedItems);\n    }\n\n    const filtered = items.filter(item => {\n      if (item.name === \"separator\") return true;\n\n      if (item.name && !commands[item.name] && !commands[`create${capitalize_1.default(item.name)}`]) {\n        return false;\n      }\n\n      if (!uploadImage && item.name === \"image\") return false;\n      if (!search) return !item.defaultHidden;\n      const n = search.toLowerCase();\n      return (item.title || \"\").toLowerCase().includes(n) || (item.keywords || \"\").toLowerCase().includes(n);\n    });\n    return filtered.reduce((acc, item, index) => {\n      if (item.name === \"separator\" && index === 0) return acc;\n      if (item.name === \"separator\" && index === filtered.length - 1) return acc;\n      const prev = filtered[index - 1];\n      if (prev && prev.name === \"separator\" && item.name === \"separator\") return acc;\n      const next = filtered[index + 1];\n      if (next && next.name === \"separator\" && item.name === \"separator\") return acc;\n      return [...acc, item];\n    }, []);\n  }\n\n  render() {\n    const {\n      dictionary,\n      isActive,\n      uploadImage\n    } = this.props;\n    const items = this.filtered;\n\n    const _a = this.state,\n          {\n      insertItem\n    } = _a,\n          positioning = __rest(_a, [\"insertItem\"]);\n\n    return React.createElement(react_portal_1.Portal, null, React.createElement(exports.Wrapper, Object.assign({\n      id: \"block-menu-container\",\n      active: isActive,\n      ref: this.menuRef\n    }, positioning), insertItem ? React.createElement(LinkInputWrapper, null, React.createElement(LinkInput, {\n      type: \"text\",\n      placeholder: insertItem.title ? dictionary.pasteLinkWithTitle(insertItem.title) : dictionary.pasteLink,\n      onKeyDown: this.handleLinkInputKeydown,\n      onPaste: this.handleLinkInputPaste,\n      autoFocus: true\n    })) : React.createElement(List, null, items.map((item, index) => {\n      if (item.name === \"separator\") {\n        return React.createElement(ListItem, {\n          key: index\n        }, React.createElement(\"hr\", null));\n      }\n\n      const selected = index === this.state.selectedIndex && isActive;\n\n      if (!item.title || !item.icon) {\n        return null;\n      }\n\n      return React.createElement(ListItem, {\n        key: index\n      }, React.createElement(BlockMenuItem_1.default, {\n        onClick: () => this.insertItem(item),\n        selected: selected,\n        icon: item.icon,\n        title: item.title,\n        shortcut: item.shortcut\n      }));\n    }), items.length === 0 && React.createElement(ListItem, null, React.createElement(Empty, null, dictionary.noResults))), uploadImage && React.createElement(VisuallyHidden_1.default, null, React.createElement(\"input\", {\n      type: \"file\",\n      ref: this.inputRef,\n      onChange: this.handleImagePicked,\n      accept: \"image/*\"\n    }))));\n  }\n\n}\n\nconst LinkInputWrapper = styled_components_1.default.div`\n  margin: 8px;\n`;\nconst LinkInput = styled_components_1.default(Input_1.default)`\n  height: 36px;\n  width: 100%;\n  color: ${props => props.theme.blockToolbarText};\n`;\nconst List = styled_components_1.default.ol`\n  list-style: none;\n  text-align: left;\n  height: 100%;\n  padding: 8px 0;\n  margin: 0;\n`;\nconst ListItem = styled_components_1.default.li`\n  padding: 0;\n  margin: 0;\n`;\nconst Empty = styled_components_1.default.div`\n  display: flex;\n  align-items: center;\n  color: ${props => props.theme.textSecondary};\n  font-weight: 500;\n  font-size: 14px;\n  height: 36px;\n  padding: 0 16px;\n`;\nexports.Wrapper = styled_components_1.default.div`\n  color: ${props => props.theme.text};\n  font-family: ${props => props.theme.fontFamily};\n  position: absolute;\n  z-index: ${props => {\n  return props.theme.zIndex + 100;\n}};\n  ${props => props.top !== undefined && `top: ${props.top}px`};\n  ${props => props.bottom !== undefined && `bottom: ${props.bottom}px`};\n  left: ${props => props.left}px;\n  background-color: ${props => props.theme.blockToolbarBackground};\n  border-radius: 4px;\n  box-shadow: rgba(0, 0, 0, 0.05) 0px 0px 0px 1px,\n    rgba(0, 0, 0, 0.08) 0px 4px 8px, rgba(0, 0, 0, 0.08) 0px 2px 4px;\n  opacity: 0;\n  transform: scale(0.95);\n  transition: opacity 150ms cubic-bezier(0.175, 0.885, 0.32, 1.275),\n    transform 150ms cubic-bezier(0.175, 0.885, 0.32, 1.275);\n  transition-delay: 150ms;\n  line-height: 0;\n  box-sizing: border-box;\n  pointer-events: none;\n  white-space: nowrap;\n  width: 300px;\n  max-height: 224px;\n  overflow: hidden;\n  overflow-y: auto;\n\n  * {\n    box-sizing: border-box;\n  }\n\n  hr {\n    border: 0;\n    height: 0;\n    border-top: 1px solid ${props => props.theme.blockToolbarDivider};\n  }\n\n  ${({\n  active,\n  isAbove\n}) => active && `\n    transform: translateY(${isAbove ? \"6px\" : \"-6px\"}) scale(1);\n    pointer-events: all;\n    opacity: 1;\n  `};\n\n  @media print {\n    display: none;\n  }\n`;\nexports.default = BlockMenu;","map":{"version":3,"sources":["../../src/components/BlockMenu.tsx"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["\"use strict\";\nvar __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });\n}) : (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    o[k2] = m[k];\n}));\nvar __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {\n    Object.defineProperty(o, \"default\", { enumerable: true, value: v });\n}) : function(o, v) {\n    o[\"default\"] = v;\n});\nvar __importStar = (this && this.__importStar) || function (mod) {\n    if (mod && mod.__esModule) return mod;\n    var result = {};\n    if (mod != null) for (var k in mod) if (k !== \"default\" && Object.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n    __setModuleDefault(result, mod);\n    return result;\n};\nvar __rest = (this && this.__rest) || function (s, e) {\n    var t = {};\n    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)\n        t[p] = s[p];\n    if (s != null && typeof Object.getOwnPropertySymbols === \"function\")\n        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {\n            if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i]))\n                t[p[i]] = s[p[i]];\n        }\n    return t;\n};\nvar __importDefault = (this && this.__importDefault) || function (mod) {\n    return (mod && mod.__esModule) ? mod : { \"default\": mod };\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.Wrapper = void 0;\nconst React = __importStar(require(\"react\"));\nconst capitalize_1 = __importDefault(require(\"lodash/capitalize\"));\nconst react_portal_1 = require(\"react-portal\");\nconst prosemirror_utils_1 = require(\"prosemirror-utils\");\nconst styled_components_1 = __importDefault(require(\"styled-components\"));\nconst types_1 = require(\"../types\");\nconst BlockMenuItem_1 = __importDefault(require(\"./BlockMenuItem\"));\nconst Input_1 = __importDefault(require(\"./Input\"));\nconst VisuallyHidden_1 = __importDefault(require(\"./VisuallyHidden\"));\nconst getDataTransferFiles_1 = __importDefault(require(\"../lib/getDataTransferFiles\"));\nconst insertFiles_1 = __importDefault(require(\"../commands/insertFiles\"));\nconst block_1 = __importDefault(require(\"../menus/block\"));\nconst SSR = typeof window === \"undefined\";\nconst defaultPosition = {\n    left: -1000,\n    top: 0,\n    bottom: undefined,\n    isAbove: false,\n};\nclass BlockMenu extends React.Component {\n    constructor() {\n        super(...arguments);\n        this.menuRef = React.createRef();\n        this.inputRef = React.createRef();\n        this.state = {\n            left: -1000,\n            top: 0,\n            bottom: undefined,\n            isAbove: false,\n            selectedIndex: 0,\n            insertItem: undefined,\n        };\n        this.handleKeyDown = (event) => {\n            if (!this.props.isActive)\n                return;\n            if (event.key === \"Enter\") {\n                event.preventDefault();\n                event.stopPropagation();\n                const item = this.filtered[this.state.selectedIndex];\n                if (item) {\n                    this.insertItem(item);\n                }\n                else {\n                    this.props.onClose();\n                }\n            }\n            if (event.key === \"ArrowUp\" || (event.ctrlKey && event.key === \"p\")) {\n                event.preventDefault();\n                event.stopPropagation();\n                if (this.filtered.length) {\n                    const prevIndex = this.state.selectedIndex - 1;\n                    const prev = this.filtered[prevIndex];\n                    this.setState({\n                        selectedIndex: Math.max(0, prev && prev.name === \"separator\" ? prevIndex - 1 : prevIndex),\n                    });\n                }\n                else {\n                    this.close();\n                }\n            }\n            if (event.key === \"ArrowDown\" ||\n                event.key === \"Tab\" ||\n                (event.ctrlKey && event.key === \"n\")) {\n                event.preventDefault();\n                event.stopPropagation();\n                if (this.filtered.length) {\n                    const total = this.filtered.length - 1;\n                    const nextIndex = this.state.selectedIndex + 1;\n                    const next = this.filtered[nextIndex];\n                    this.setState({\n                        selectedIndex: Math.min(next && next.name === \"separator\" ? nextIndex + 1 : nextIndex, total),\n                    });\n                }\n                else {\n                    this.close();\n                }\n            }\n            if (event.key === \"Escape\") {\n                this.close();\n            }\n        };\n        this.insertItem = item => {\n            switch (item.name) {\n                case \"image\":\n                    return this.triggerImagePick();\n                case \"embed\":\n                    return this.triggerLinkInput(item);\n                case \"link\": {\n                    this.clearSearch();\n                    this.props.onClose();\n                    this.props.onLinkToolbarOpen();\n                    return;\n                }\n                default:\n                    this.insertBlock(item);\n            }\n        };\n        this.close = () => {\n            this.props.onClose();\n            this.props.view.focus();\n        };\n        this.handleLinkInputKeydown = (event) => {\n            if (!this.props.isActive)\n                return;\n            if (!this.state.insertItem)\n                return;\n            if (event.key === \"Enter\") {\n                event.preventDefault();\n                event.stopPropagation();\n                const href = event.currentTarget.value;\n                const matches = this.state.insertItem.matcher(href);\n                if (!matches && this.props.onShowToast) {\n                    this.props.onShowToast(this.props.dictionary.embedInvalidLink, types_1.ToastType.Error);\n                    return;\n                }\n                this.insertBlock({\n                    name: \"embed\",\n                    attrs: {\n                        href,\n                        component: this.state.insertItem.component,\n                        matches,\n                    },\n                });\n            }\n            if (event.key === \"Escape\") {\n                this.props.onClose();\n                this.props.view.focus();\n            }\n        };\n        this.handleLinkInputPaste = (event) => {\n            if (!this.props.isActive)\n                return;\n            if (!this.state.insertItem)\n                return;\n            const href = event.clipboardData.getData(\"text/plain\");\n            const matches = this.state.insertItem.matcher(href);\n            if (matches) {\n                event.preventDefault();\n                event.stopPropagation();\n                this.insertBlock({\n                    name: \"embed\",\n                    attrs: {\n                        href,\n                        component: this.state.insertItem.component,\n                        matches,\n                    },\n                });\n            }\n        };\n        this.triggerImagePick = () => {\n            if (this.inputRef.current) {\n                this.inputRef.current.click();\n            }\n        };\n        this.triggerLinkInput = item => {\n            this.setState({ insertItem: item });\n        };\n        this.handleImagePicked = event => {\n            const files = getDataTransferFiles_1.default(event);\n            const { view, uploadImage, onImageUploadStart, onImageUploadStop, onShowToast, } = this.props;\n            const { state } = view;\n            const parent = prosemirror_utils_1.findParentNode(node => !!node)(state.selection);\n            this.clearSearch();\n            if (parent) {\n                insertFiles_1.default(view, event, parent.pos, files, {\n                    uploadImage,\n                    onImageUploadStart,\n                    onImageUploadStop,\n                    onShowToast,\n                    dictionary: this.props.dictionary,\n                });\n            }\n            if (this.inputRef.current) {\n                this.inputRef.current.value = \"\";\n            }\n            this.props.onClose();\n        };\n    }\n    componentDidMount() {\n        if (!SSR) {\n            window.addEventListener(\"keydown\", this.handleKeyDown);\n        }\n    }\n    shouldComponentUpdate(nextProps, nextState) {\n        return (nextProps.search !== this.props.search ||\n            nextProps.isActive !== this.props.isActive ||\n            nextState !== this.state);\n    }\n    componentDidUpdate(prevProps) {\n        if (!prevProps.isActive && this.props.isActive) {\n            const position = this.calculatePosition(this.props);\n            this.setState(Object.assign({ insertItem: undefined, selectedIndex: 0 }, position));\n        }\n        else if (prevProps.search !== this.props.search) {\n            this.setState({ selectedIndex: 0 });\n        }\n    }\n    componentWillUnmount() {\n        if (!SSR) {\n            window.removeEventListener(\"keydown\", this.handleKeyDown);\n        }\n    }\n    clearSearch() {\n        const { state, dispatch } = this.props.view;\n        const parent = prosemirror_utils_1.findParentNode(node => !!node)(state.selection);\n        if (parent) {\n            dispatch(state.tr.insertText(\"\", parent.pos, state.selection.to));\n        }\n    }\n    insertBlock(item) {\n        this.clearSearch();\n        const command = this.props.commands[item.name];\n        if (command) {\n            command(item.attrs);\n        }\n        else {\n            this.props.commands[`create${capitalize_1.default(item.name)}`](item.attrs);\n        }\n        this.props.onClose();\n    }\n    get caretPosition() {\n        const selection = window.document.getSelection();\n        if (!selection || !selection.anchorNode || !selection.focusNode) {\n            return {\n                top: 0,\n                left: 0,\n            };\n        }\n        const range = window.document.createRange();\n        range.setStart(selection.anchorNode, selection.anchorOffset);\n        range.setEnd(selection.focusNode, selection.focusOffset);\n        const rects = range.getClientRects();\n        if (rects.length === 0) {\n            if (range.startContainer && range.collapsed) {\n                range.selectNodeContents(range.startContainer);\n            }\n        }\n        const rect = range.getBoundingClientRect();\n        return {\n            top: rect.top,\n            left: rect.left,\n        };\n    }\n    calculatePosition(props) {\n        const { view } = props;\n        const { selection } = view.state;\n        let startPos;\n        try {\n            startPos = view.coordsAtPos(selection.from);\n        }\n        catch (err) {\n            console.warn(err);\n            return defaultPosition;\n        }\n        const ref = this.menuRef.current;\n        const offsetHeight = ref ? ref.offsetHeight : 0;\n        const paragraph = view.domAtPos(selection.from);\n        if (!props.isActive ||\n            !paragraph.node ||\n            !paragraph.node.getBoundingClientRect ||\n            SSR) {\n            return defaultPosition;\n        }\n        const { left } = this.caretPosition;\n        const { top, bottom, right } = paragraph.node.getBoundingClientRect();\n        const margin = 24;\n        let leftPos = left + window.scrollX;\n        if (props.rtl && ref) {\n            leftPos = right - ref.scrollWidth;\n        }\n        if (startPos.top - offsetHeight > margin) {\n            return {\n                left: leftPos,\n                top: undefined,\n                bottom: window.innerHeight - top - window.scrollY,\n                isAbove: false,\n            };\n        }\n        else {\n            return {\n                left: leftPos,\n                top: bottom + window.scrollY,\n                bottom: undefined,\n                isAbove: true,\n            };\n        }\n    }\n    get filtered() {\n        const { dictionary, embeds, search = \"\", uploadImage, commands, } = this.props;\n        let items = block_1.default(dictionary);\n        const embedItems = [];\n        for (const embed of embeds) {\n            if (embed.title && embed.icon) {\n                embedItems.push(Object.assign(Object.assign({}, embed), { name: \"embed\" }));\n            }\n        }\n        if (embedItems.length) {\n            items.push({\n                name: \"separator\",\n            });\n            items = items.concat(embedItems);\n        }\n        const filtered = items.filter(item => {\n            if (item.name === \"separator\")\n                return true;\n            if (item.name &&\n                !commands[item.name] &&\n                !commands[`create${capitalize_1.default(item.name)}`]) {\n                return false;\n            }\n            if (!uploadImage && item.name === \"image\")\n                return false;\n            if (!search)\n                return !item.defaultHidden;\n            const n = search.toLowerCase();\n            return ((item.title || \"\").toLowerCase().includes(n) ||\n                (item.keywords || \"\").toLowerCase().includes(n));\n        });\n        return filtered.reduce((acc, item, index) => {\n            if (item.name === \"separator\" && index === 0)\n                return acc;\n            if (item.name === \"separator\" && index === filtered.length - 1)\n                return acc;\n            const prev = filtered[index - 1];\n            if (prev && prev.name === \"separator\" && item.name === \"separator\")\n                return acc;\n            const next = filtered[index + 1];\n            if (next && next.name === \"separator\" && item.name === \"separator\")\n                return acc;\n            return [...acc, item];\n        }, []);\n    }\n    render() {\n        const { dictionary, isActive, uploadImage } = this.props;\n        const items = this.filtered;\n        const _a = this.state, { insertItem } = _a, positioning = __rest(_a, [\"insertItem\"]);\n        return (React.createElement(react_portal_1.Portal, null,\n            React.createElement(exports.Wrapper, Object.assign({ id: \"block-menu-container\", active: isActive, ref: this.menuRef }, positioning),\n                insertItem ? (React.createElement(LinkInputWrapper, null,\n                    React.createElement(LinkInput, { type: \"text\", placeholder: insertItem.title\n                            ? dictionary.pasteLinkWithTitle(insertItem.title)\n                            : dictionary.pasteLink, onKeyDown: this.handleLinkInputKeydown, onPaste: this.handleLinkInputPaste, autoFocus: true }))) : (React.createElement(List, null,\n                    items.map((item, index) => {\n                        if (item.name === \"separator\") {\n                            return (React.createElement(ListItem, { key: index },\n                                React.createElement(\"hr\", null)));\n                        }\n                        const selected = index === this.state.selectedIndex && isActive;\n                        if (!item.title || !item.icon) {\n                            return null;\n                        }\n                        return (React.createElement(ListItem, { key: index },\n                            React.createElement(BlockMenuItem_1.default, { onClick: () => this.insertItem(item), selected: selected, icon: item.icon, title: item.title, shortcut: item.shortcut })));\n                    }),\n                    items.length === 0 && (React.createElement(ListItem, null,\n                        React.createElement(Empty, null, dictionary.noResults))))),\n                uploadImage && (React.createElement(VisuallyHidden_1.default, null,\n                    React.createElement(\"input\", { type: \"file\", ref: this.inputRef, onChange: this.handleImagePicked, accept: \"image/*\" }))))));\n    }\n}\nconst LinkInputWrapper = styled_components_1.default.div `\n  margin: 8px;\n`;\nconst LinkInput = styled_components_1.default(Input_1.default) `\n  height: 36px;\n  width: 100%;\n  color: ${props => props.theme.blockToolbarText};\n`;\nconst List = styled_components_1.default.ol `\n  list-style: none;\n  text-align: left;\n  height: 100%;\n  padding: 8px 0;\n  margin: 0;\n`;\nconst ListItem = styled_components_1.default.li `\n  padding: 0;\n  margin: 0;\n`;\nconst Empty = styled_components_1.default.div `\n  display: flex;\n  align-items: center;\n  color: ${props => props.theme.textSecondary};\n  font-weight: 500;\n  font-size: 14px;\n  height: 36px;\n  padding: 0 16px;\n`;\nexports.Wrapper = styled_components_1.default.div `\n  color: ${props => props.theme.text};\n  font-family: ${props => props.theme.fontFamily};\n  position: absolute;\n  z-index: ${props => {\n    return props.theme.zIndex + 100;\n}};\n  ${props => props.top !== undefined && `top: ${props.top}px`};\n  ${props => props.bottom !== undefined && `bottom: ${props.bottom}px`};\n  left: ${props => props.left}px;\n  background-color: ${props => props.theme.blockToolbarBackground};\n  border-radius: 4px;\n  box-shadow: rgba(0, 0, 0, 0.05) 0px 0px 0px 1px,\n    rgba(0, 0, 0, 0.08) 0px 4px 8px, rgba(0, 0, 0, 0.08) 0px 2px 4px;\n  opacity: 0;\n  transform: scale(0.95);\n  transition: opacity 150ms cubic-bezier(0.175, 0.885, 0.32, 1.275),\n    transform 150ms cubic-bezier(0.175, 0.885, 0.32, 1.275);\n  transition-delay: 150ms;\n  line-height: 0;\n  box-sizing: border-box;\n  pointer-events: none;\n  white-space: nowrap;\n  width: 300px;\n  max-height: 224px;\n  overflow: hidden;\n  overflow-y: auto;\n\n  * {\n    box-sizing: border-box;\n  }\n\n  hr {\n    border: 0;\n    height: 0;\n    border-top: 1px solid ${props => props.theme.blockToolbarDivider};\n  }\n\n  ${({ active, isAbove }) => active &&\n    `\n    transform: translateY(${isAbove ? \"6px\" : \"-6px\"}) scale(1);\n    pointer-events: all;\n    opacity: 1;\n  `};\n\n  @media print {\n    display: none;\n  }\n`;\nexports.default = BlockMenu;\n//# sourceMappingURL=BlockMenu.js.map"]},"metadata":{},"sourceType":"script"}