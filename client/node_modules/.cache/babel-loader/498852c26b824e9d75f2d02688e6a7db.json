{"ast":null,"code":"\"use strict\";\n\nvar __createBinding = this && this.__createBinding || (Object.create ? function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  Object.defineProperty(o, k2, {\n    enumerable: true,\n    get: function () {\n      return m[k];\n    }\n  });\n} : function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  o[k2] = m[k];\n});\n\nvar __setModuleDefault = this && this.__setModuleDefault || (Object.create ? function (o, v) {\n  Object.defineProperty(o, \"default\", {\n    enumerable: true,\n    value: v\n  });\n} : function (o, v) {\n  o[\"default\"] = v;\n});\n\nvar __importStar = this && this.__importStar || function (mod) {\n  if (mod && mod.__esModule) return mod;\n  var result = {};\n  if (mod != null) for (var k in mod) if (k !== \"default\" && Object.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n\n  __setModuleDefault(result, mod);\n\n  return result;\n};\n\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nconst React = __importStar(require(\"react\"));\n\nconst prosemirror_utils_1 = require(\"prosemirror-utils\");\n\nconst outline_icons_1 = require(\"outline-icons\");\n\nconst styled_components_1 = __importStar(require(\"styled-components\"));\n\nconst isUrl_1 = __importDefault(require(\"../lib/isUrl\"));\n\nconst Flex_1 = __importDefault(require(\"./Flex\"));\n\nconst Input_1 = __importDefault(require(\"./Input\"));\n\nconst ToolbarButton_1 = __importDefault(require(\"./ToolbarButton\"));\n\nconst LinkSearchResult_1 = __importDefault(require(\"./LinkSearchResult\"));\n\nclass LinkEditor extends React.Component {\n  constructor() {\n    super(...arguments);\n    this.discardInputValue = false;\n    this.initialValue = this.href;\n    this.initialSelectionLength = this.props.to - this.props.from;\n    this.state = {\n      selectedIndex: -1,\n      value: this.href,\n      previousValue: \"\",\n      results: {}\n    };\n\n    this.componentWillUnmount = () => {\n      if (this.discardInputValue) {\n        return;\n      }\n\n      if (this.state.value === this.initialValue) {\n        return;\n      }\n\n      const href = (this.state.value || \"\").trim();\n\n      if (!href) {\n        return this.handleRemoveLink();\n      }\n\n      this.save(href, href);\n    };\n\n    this.save = (href, title) => {\n      href = href.trim();\n      if (href.length === 0) return;\n      this.discardInputValue = true;\n      const {\n        from,\n        to\n      } = this.props;\n\n      if (!isUrl_1.default(href) && !href.startsWith(\"/\")) {\n        href = `https://${href}`;\n      }\n\n      this.props.onSelectLink({\n        href,\n        title,\n        from,\n        to\n      });\n    };\n\n    this.handleKeyDown = event => {\n      switch (event.key) {\n        case \"Enter\":\n          {\n            event.preventDefault();\n            const {\n              selectedIndex,\n              value\n            } = this.state;\n            const results = this.state.results[value] || [];\n            const {\n              onCreateLink\n            } = this.props;\n\n            if (selectedIndex >= 0) {\n              const result = results[selectedIndex];\n\n              if (result) {\n                this.save(result.url, result.title);\n              } else if (onCreateLink && selectedIndex === results.length) {\n                this.handleCreateLink(this.suggestedLinkTitle);\n              }\n            } else {\n              this.save(value, value);\n            }\n\n            if (this.initialSelectionLength) {\n              this.moveSelectionToEnd();\n            }\n\n            return;\n          }\n\n        case \"Escape\":\n          {\n            event.preventDefault();\n\n            if (this.initialValue) {\n              this.setState({\n                value: this.initialValue\n              }, this.moveSelectionToEnd);\n            } else {\n              this.handleRemoveLink();\n            }\n\n            return;\n          }\n\n        case \"ArrowUp\":\n          {\n            if (event.shiftKey) return;\n            event.preventDefault();\n            event.stopPropagation();\n            const prevIndex = this.state.selectedIndex - 1;\n            this.setState({\n              selectedIndex: Math.max(-1, prevIndex)\n            });\n            return;\n          }\n\n        case \"ArrowDown\":\n          if (event.shiftKey) return;\n\n        case \"Tab\":\n          {\n            event.preventDefault();\n            event.stopPropagation();\n            const {\n              selectedIndex,\n              value\n            } = this.state;\n            const results = this.state.results[value] || [];\n            const total = results.length;\n            const nextIndex = selectedIndex + 1;\n            this.setState({\n              selectedIndex: Math.min(nextIndex, total)\n            });\n            return;\n          }\n      }\n    };\n\n    this.handleFocusLink = selectedIndex => {\n      this.setState({\n        selectedIndex\n      });\n    };\n\n    this.handleChange = async event => {\n      const value = event.target.value;\n      this.setState({\n        value,\n        selectedIndex: -1\n      });\n      const trimmedValue = value.trim();\n\n      if (trimmedValue && this.props.onSearchLink) {\n        try {\n          const results = await this.props.onSearchLink(trimmedValue);\n          this.setState(state => ({\n            results: Object.assign(Object.assign({}, state.results), {\n              [trimmedValue]: results\n            }),\n            previousValue: trimmedValue\n          }));\n        } catch (error) {\n          console.error(error);\n        }\n      }\n    };\n\n    this.handleOpenLink = event => {\n      event.preventDefault();\n      this.props.onClickLink(this.href, event);\n    };\n\n    this.handleCreateLink = value => {\n      this.discardInputValue = true;\n      const {\n        onCreateLink\n      } = this.props;\n      value = value.trim();\n      if (value.length === 0) return;\n      if (onCreateLink) return onCreateLink(value);\n    };\n\n    this.handleRemoveLink = () => {\n      this.discardInputValue = true;\n      const {\n        from,\n        to,\n        mark,\n        view,\n        onRemoveLink\n      } = this.props;\n      const {\n        state,\n        dispatch\n      } = this.props.view;\n\n      if (mark) {\n        dispatch(state.tr.removeMark(from, to, mark));\n      }\n\n      if (onRemoveLink) {\n        onRemoveLink();\n      }\n\n      view.focus();\n    };\n\n    this.handleSelectLink = (url, title) => event => {\n      event.preventDefault();\n      this.save(url, title);\n\n      if (this.initialSelectionLength) {\n        this.moveSelectionToEnd();\n      }\n    };\n\n    this.moveSelectionToEnd = () => {\n      const {\n        to,\n        view\n      } = this.props;\n      const {\n        state,\n        dispatch\n      } = view;\n      dispatch(prosemirror_utils_1.setTextSelection(to)(state.tr));\n      view.focus();\n    };\n  }\n\n  get href() {\n    return this.props.mark ? this.props.mark.attrs.href : \"\";\n  }\n\n  get suggestedLinkTitle() {\n    const {\n      state\n    } = this.props.view;\n    const {\n      value\n    } = this.state;\n    const selectionText = state.doc.cut(state.selection.from, state.selection.to).textContent;\n    return value.trim() || selectionText.trim();\n  }\n\n  render() {\n    const {\n      dictionary,\n      theme\n    } = this.props;\n    const {\n      value,\n      selectedIndex\n    } = this.state;\n    const results = this.state.results[value.trim()] || this.state.results[this.state.previousValue] || [];\n    const Tooltip = this.props.tooltip;\n    const looksLikeUrl = value.match(/^https?:\\/\\//i);\n    const suggestedLinkTitle = this.suggestedLinkTitle;\n    const showCreateLink = !!this.props.onCreateLink && !(suggestedLinkTitle === this.initialValue) && suggestedLinkTitle.length > 0 && !looksLikeUrl;\n    const showResults = !!suggestedLinkTitle && (showCreateLink || results.length > 0);\n    return React.createElement(Wrapper, null, React.createElement(Input_1.default, {\n      value: value,\n      placeholder: showCreateLink ? dictionary.findOrCreateDoc : dictionary.searchOrPasteLink,\n      onKeyDown: this.handleKeyDown,\n      onChange: this.handleChange,\n      autoFocus: this.href === \"\"\n    }), React.createElement(ToolbarButton_1.default, {\n      onClick: this.handleOpenLink,\n      disabled: !value\n    }, React.createElement(Tooltip, {\n      tooltip: dictionary.openLink,\n      placement: \"top\"\n    }, React.createElement(outline_icons_1.OpenIcon, {\n      color: theme.toolbarItem\n    }))), React.createElement(ToolbarButton_1.default, {\n      onClick: this.handleRemoveLink\n    }, React.createElement(Tooltip, {\n      tooltip: dictionary.removeLink,\n      placement: \"top\"\n    }, this.initialValue ? React.createElement(outline_icons_1.TrashIcon, {\n      color: theme.toolbarItem\n    }) : React.createElement(outline_icons_1.CloseIcon, {\n      color: theme.toolbarItem\n    }))), showResults && React.createElement(SearchResults, {\n      id: \"link-search-results\"\n    }, results.map((result, index) => React.createElement(LinkSearchResult_1.default, {\n      key: result.url,\n      title: result.title,\n      subtitle: result.subtitle,\n      icon: React.createElement(outline_icons_1.DocumentIcon, {\n        color: theme.toolbarItem\n      }),\n      onMouseOver: () => this.handleFocusLink(index),\n      onClick: this.handleSelectLink(result.url, result.title),\n      selected: index === selectedIndex\n    })), showCreateLink && React.createElement(LinkSearchResult_1.default, {\n      key: \"create\",\n      title: suggestedLinkTitle,\n      subtitle: dictionary.createNewDoc,\n      icon: React.createElement(outline_icons_1.PlusIcon, {\n        color: theme.toolbarItem\n      }),\n      onMouseOver: () => this.handleFocusLink(results.length),\n      onClick: () => {\n        this.handleCreateLink(suggestedLinkTitle);\n\n        if (this.initialSelectionLength) {\n          this.moveSelectionToEnd();\n        }\n      },\n      selected: results.length === selectedIndex\n    })));\n  }\n\n}\n\nconst Wrapper = styled_components_1.default(Flex_1.default)`\n  margin-left: -8px;\n  margin-right: -8px;\n  min-width: 336px;\n`;\nconst SearchResults = styled_components_1.default.ol`\n  background: ${props => props.theme.toolbarBackground};\n  position: absolute;\n  top: 100%;\n  width: 100%;\n  height: auto;\n  left: 0;\n  padding: 4px 8px 8px;\n  margin: 0;\n  margin-top: -3px;\n  margin-bottom: 0;\n  border-radius: 0 0 4px 4px;\n  overflow-y: auto;\n  max-height: 25vh;\n\n  @media (hover: none) and (pointer: coarse) {\n    position: fixed;\n    top: auto;\n    bottom: 40px;\n    border-radius: 0;\n    max-height: 50vh;\n    padding: 8px 8px 4px;\n  }\n`;\nexports.default = styled_components_1.withTheme(LinkEditor);","map":{"version":3,"sources":["../../src/components/LinkEditor.tsx"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["\"use strict\";\nvar __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });\n}) : (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    o[k2] = m[k];\n}));\nvar __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {\n    Object.defineProperty(o, \"default\", { enumerable: true, value: v });\n}) : function(o, v) {\n    o[\"default\"] = v;\n});\nvar __importStar = (this && this.__importStar) || function (mod) {\n    if (mod && mod.__esModule) return mod;\n    var result = {};\n    if (mod != null) for (var k in mod) if (k !== \"default\" && Object.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n    __setModuleDefault(result, mod);\n    return result;\n};\nvar __importDefault = (this && this.__importDefault) || function (mod) {\n    return (mod && mod.__esModule) ? mod : { \"default\": mod };\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nconst React = __importStar(require(\"react\"));\nconst prosemirror_utils_1 = require(\"prosemirror-utils\");\nconst outline_icons_1 = require(\"outline-icons\");\nconst styled_components_1 = __importStar(require(\"styled-components\"));\nconst isUrl_1 = __importDefault(require(\"../lib/isUrl\"));\nconst Flex_1 = __importDefault(require(\"./Flex\"));\nconst Input_1 = __importDefault(require(\"./Input\"));\nconst ToolbarButton_1 = __importDefault(require(\"./ToolbarButton\"));\nconst LinkSearchResult_1 = __importDefault(require(\"./LinkSearchResult\"));\nclass LinkEditor extends React.Component {\n    constructor() {\n        super(...arguments);\n        this.discardInputValue = false;\n        this.initialValue = this.href;\n        this.initialSelectionLength = this.props.to - this.props.from;\n        this.state = {\n            selectedIndex: -1,\n            value: this.href,\n            previousValue: \"\",\n            results: {},\n        };\n        this.componentWillUnmount = () => {\n            if (this.discardInputValue) {\n                return;\n            }\n            if (this.state.value === this.initialValue) {\n                return;\n            }\n            const href = (this.state.value || \"\").trim();\n            if (!href) {\n                return this.handleRemoveLink();\n            }\n            this.save(href, href);\n        };\n        this.save = (href, title) => {\n            href = href.trim();\n            if (href.length === 0)\n                return;\n            this.discardInputValue = true;\n            const { from, to } = this.props;\n            if (!isUrl_1.default(href) && !href.startsWith(\"/\")) {\n                href = `https://${href}`;\n            }\n            this.props.onSelectLink({ href, title, from, to });\n        };\n        this.handleKeyDown = (event) => {\n            switch (event.key) {\n                case \"Enter\": {\n                    event.preventDefault();\n                    const { selectedIndex, value } = this.state;\n                    const results = this.state.results[value] || [];\n                    const { onCreateLink } = this.props;\n                    if (selectedIndex >= 0) {\n                        const result = results[selectedIndex];\n                        if (result) {\n                            this.save(result.url, result.title);\n                        }\n                        else if (onCreateLink && selectedIndex === results.length) {\n                            this.handleCreateLink(this.suggestedLinkTitle);\n                        }\n                    }\n                    else {\n                        this.save(value, value);\n                    }\n                    if (this.initialSelectionLength) {\n                        this.moveSelectionToEnd();\n                    }\n                    return;\n                }\n                case \"Escape\": {\n                    event.preventDefault();\n                    if (this.initialValue) {\n                        this.setState({ value: this.initialValue }, this.moveSelectionToEnd);\n                    }\n                    else {\n                        this.handleRemoveLink();\n                    }\n                    return;\n                }\n                case \"ArrowUp\": {\n                    if (event.shiftKey)\n                        return;\n                    event.preventDefault();\n                    event.stopPropagation();\n                    const prevIndex = this.state.selectedIndex - 1;\n                    this.setState({\n                        selectedIndex: Math.max(-1, prevIndex),\n                    });\n                    return;\n                }\n                case \"ArrowDown\":\n                    if (event.shiftKey)\n                        return;\n                case \"Tab\": {\n                    event.preventDefault();\n                    event.stopPropagation();\n                    const { selectedIndex, value } = this.state;\n                    const results = this.state.results[value] || [];\n                    const total = results.length;\n                    const nextIndex = selectedIndex + 1;\n                    this.setState({\n                        selectedIndex: Math.min(nextIndex, total),\n                    });\n                    return;\n                }\n            }\n        };\n        this.handleFocusLink = (selectedIndex) => {\n            this.setState({ selectedIndex });\n        };\n        this.handleChange = async (event) => {\n            const value = event.target.value;\n            this.setState({\n                value,\n                selectedIndex: -1,\n            });\n            const trimmedValue = value.trim();\n            if (trimmedValue && this.props.onSearchLink) {\n                try {\n                    const results = await this.props.onSearchLink(trimmedValue);\n                    this.setState(state => ({\n                        results: Object.assign(Object.assign({}, state.results), { [trimmedValue]: results }),\n                        previousValue: trimmedValue,\n                    }));\n                }\n                catch (error) {\n                    console.error(error);\n                }\n            }\n        };\n        this.handleOpenLink = (event) => {\n            event.preventDefault();\n            this.props.onClickLink(this.href, event);\n        };\n        this.handleCreateLink = (value) => {\n            this.discardInputValue = true;\n            const { onCreateLink } = this.props;\n            value = value.trim();\n            if (value.length === 0)\n                return;\n            if (onCreateLink)\n                return onCreateLink(value);\n        };\n        this.handleRemoveLink = () => {\n            this.discardInputValue = true;\n            const { from, to, mark, view, onRemoveLink } = this.props;\n            const { state, dispatch } = this.props.view;\n            if (mark) {\n                dispatch(state.tr.removeMark(from, to, mark));\n            }\n            if (onRemoveLink) {\n                onRemoveLink();\n            }\n            view.focus();\n        };\n        this.handleSelectLink = (url, title) => event => {\n            event.preventDefault();\n            this.save(url, title);\n            if (this.initialSelectionLength) {\n                this.moveSelectionToEnd();\n            }\n        };\n        this.moveSelectionToEnd = () => {\n            const { to, view } = this.props;\n            const { state, dispatch } = view;\n            dispatch(prosemirror_utils_1.setTextSelection(to)(state.tr));\n            view.focus();\n        };\n    }\n    get href() {\n        return this.props.mark ? this.props.mark.attrs.href : \"\";\n    }\n    get suggestedLinkTitle() {\n        const { state } = this.props.view;\n        const { value } = this.state;\n        const selectionText = state.doc.cut(state.selection.from, state.selection.to).textContent;\n        return value.trim() || selectionText.trim();\n    }\n    render() {\n        const { dictionary, theme } = this.props;\n        const { value, selectedIndex } = this.state;\n        const results = this.state.results[value.trim()] ||\n            this.state.results[this.state.previousValue] ||\n            [];\n        const Tooltip = this.props.tooltip;\n        const looksLikeUrl = value.match(/^https?:\\/\\//i);\n        const suggestedLinkTitle = this.suggestedLinkTitle;\n        const showCreateLink = !!this.props.onCreateLink &&\n            !(suggestedLinkTitle === this.initialValue) &&\n            suggestedLinkTitle.length > 0 &&\n            !looksLikeUrl;\n        const showResults = !!suggestedLinkTitle && (showCreateLink || results.length > 0);\n        return (React.createElement(Wrapper, null,\n            React.createElement(Input_1.default, { value: value, placeholder: showCreateLink\n                    ? dictionary.findOrCreateDoc\n                    : dictionary.searchOrPasteLink, onKeyDown: this.handleKeyDown, onChange: this.handleChange, autoFocus: this.href === \"\" }),\n            React.createElement(ToolbarButton_1.default, { onClick: this.handleOpenLink, disabled: !value },\n                React.createElement(Tooltip, { tooltip: dictionary.openLink, placement: \"top\" },\n                    React.createElement(outline_icons_1.OpenIcon, { color: theme.toolbarItem }))),\n            React.createElement(ToolbarButton_1.default, { onClick: this.handleRemoveLink },\n                React.createElement(Tooltip, { tooltip: dictionary.removeLink, placement: \"top\" }, this.initialValue ? (React.createElement(outline_icons_1.TrashIcon, { color: theme.toolbarItem })) : (React.createElement(outline_icons_1.CloseIcon, { color: theme.toolbarItem })))),\n            showResults && (React.createElement(SearchResults, { id: \"link-search-results\" },\n                results.map((result, index) => (React.createElement(LinkSearchResult_1.default, { key: result.url, title: result.title, subtitle: result.subtitle, icon: React.createElement(outline_icons_1.DocumentIcon, { color: theme.toolbarItem }), onMouseOver: () => this.handleFocusLink(index), onClick: this.handleSelectLink(result.url, result.title), selected: index === selectedIndex }))),\n                showCreateLink && (React.createElement(LinkSearchResult_1.default, { key: \"create\", title: suggestedLinkTitle, subtitle: dictionary.createNewDoc, icon: React.createElement(outline_icons_1.PlusIcon, { color: theme.toolbarItem }), onMouseOver: () => this.handleFocusLink(results.length), onClick: () => {\n                        this.handleCreateLink(suggestedLinkTitle);\n                        if (this.initialSelectionLength) {\n                            this.moveSelectionToEnd();\n                        }\n                    }, selected: results.length === selectedIndex }))))));\n    }\n}\nconst Wrapper = styled_components_1.default(Flex_1.default) `\n  margin-left: -8px;\n  margin-right: -8px;\n  min-width: 336px;\n`;\nconst SearchResults = styled_components_1.default.ol `\n  background: ${props => props.theme.toolbarBackground};\n  position: absolute;\n  top: 100%;\n  width: 100%;\n  height: auto;\n  left: 0;\n  padding: 4px 8px 8px;\n  margin: 0;\n  margin-top: -3px;\n  margin-bottom: 0;\n  border-radius: 0 0 4px 4px;\n  overflow-y: auto;\n  max-height: 25vh;\n\n  @media (hover: none) and (pointer: coarse) {\n    position: fixed;\n    top: auto;\n    bottom: 40px;\n    border-radius: 0;\n    max-height: 50vh;\n    padding: 8px 8px 4px;\n  }\n`;\nexports.default = styled_components_1.withTheme(LinkEditor);\n//# sourceMappingURL=LinkEditor.js.map"]},"metadata":{},"sourceType":"script"}